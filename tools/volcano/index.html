<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«å±±å›¾åœ¨çº¿ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        .content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            padding: 20px;
        }
        .sidebar {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        .section {
            margin-bottom: 25px;
        }
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #f5576c;
            padding-bottom: 8px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .input-group textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            padding: 12px 20px;
            background: #f5576c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }
        button:hover {
            background: #e04556;
        }
        button.secondary {
            background: #48bb78;
        }
        button.secondary:hover {
            background: #38a169;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        .file-input-label {
            display: block;
            padding: 12px 20px;
            background: #ed8936;
            color: white;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .file-input-label:hover {
            background: #dd6b20;
        }
        .preview-area {
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow: auto;
        }
        #volcanoPlot {
            background: white;
            padding: 20px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .plot-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        #plotCanvas {
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .legend {
            margin-top: 20px;
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        .example-data {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        .color-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .color-picker input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            cursor: pointer;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tab {
            padding: 8px 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .tab.active {
            background: #f5576c;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #excelTable {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-bottom: 10px;
        }
        #excelTable th, #excelTable td {
            border: 1px solid #ddd;
            padding: 8px;
            min-width: 100px;
        }
        #excelTable th {
            background: #f0f0f0;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        #excelTable td {
            background: white;
        }
        #excelTable input {
            width: 100%;
            border: none;
            padding: 4px;
            font-size: 13px;
        }
        #excelTable input:focus {
            outline: 2px solid #f5576c;
            background: #fff5f5;
        }
        .table-wrapper {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .paste-hint {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 13px;
            border-left: 4px solid #2196f3;
        }
        .stats {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ‹ ç«å±±å›¾åœ¨çº¿ç”Ÿæˆå™¨</h1>
            <p>å·®å¼‚åŸºå› è¡¨è¾¾åˆ†æå¯è§†åŒ–å·¥å…· - æ”¯æŒExcelç²˜è´´ã€åœ¨çº¿ç¼–è¾‘ã€å¯¼å‡ºé«˜è´¨é‡å›¾ç‰‡</p>
        </div>
        <div class="content">
            <div class="sidebar">
                <div class="section">
                    <h3>ğŸ“Š æ•°æ®è¾“å…¥</h3>

                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('excel')">ğŸ“‹ Excelè¡¨æ ¼</button>
                        <button class="tab" onclick="switchTab('text')">ğŸ“ æ–‡æœ¬æ¨¡å¼</button>
                    </div>

                    <div id="excelTab" class="tab-content active">
                        <div class="paste-hint">
                            ğŸ’¡ <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong><br>
                            1. ä»Excelå¤åˆ¶æ•°æ®ï¼ˆå«è¡¨å¤´ï¼‰<br>
                            2. ç‚¹å‡»ä¸‹æ–¹è¡¨æ ¼ä»»æ„å•å…ƒæ ¼<br>
                            3. æŒ‰ Ctrl+V (æˆ– Cmd+V) ç²˜è´´<br>
                            4. æˆ–ç›´æ¥åœ¨è¡¨æ ¼ä¸­è¾“å…¥/ç¼–è¾‘æ•°æ®
                        </div>
                        <div class="table-wrapper">
                            <table id="excelTable">
                                <thead>
                                    <tr>
                                        <th>Gene</th>
                                        <th>Log2FC</th>
                                        <th>P-value</th>
                                    </tr>
                                </thead>
                                <tbody id="excelTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="btn-group">
                            <button onclick="addRow()">â• æ·»åŠ è¡Œ</button>
                            <button onclick="clearTable()">ğŸ—‘ï¸ æ¸…ç©ºè¡¨æ ¼</button>
                        </div>
                    </div>

                    <div id="textTab" class="tab-content">
                        <div class="example-data">
                            ç¤ºä¾‹æ ¼å¼ï¼šåŸºå› å,Log2FC,På€¼<br>
                            Gene1,2.5,0.001<br>
                            Gene2,-1.8,0.01
                        </div>
                        <div class="input-group">
                            <label>ç²˜è´´æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰ï¼š</label>
                            <textarea id="dataInput" placeholder="Gene,Log2FC,Pvalue&#10;Gene1,2.5,0.001&#10;Gene2,-1.8,0.01"></textarea>
                            <div class="help-text">æ¯è¡Œä¸€ä¸ªåŸºå› ï¼Œç”¨é€—å·åˆ†éš”å„å­—æ®µ</div>
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" id="fileInput" accept=".csv,.txt">
                            <label for="fileInput" class="file-input-label">ğŸ“ å¯¼å…¥CSVæ–‡ä»¶</label>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>ğŸ¯ é˜ˆå€¼è®¾ç½®</h3>
                    <div class="input-group">
                        <label>Log2FC é˜ˆå€¼ï¼š</label>
                        <input type="number" id="fcThreshold" value="1" min="0" max="5" step="0.1">
                        <div class="help-text">å·®å¼‚å€æ•°çš„å¯¹æ•°å€¼é˜ˆå€¼ï¼ˆé€šå¸¸ä¸º1ï¼Œå³2å€å·®å¼‚ï¼‰</div>
                    </div>
                    <div class="input-group">
                        <label>På€¼ é˜ˆå€¼ï¼š</label>
                        <input type="number" id="pThreshold" value="0.05" min="0" max="1" step="0.01">
                        <div class="help-text">æ˜¾è‘—æ€§æ°´å¹³ï¼ˆé€šå¸¸ä¸º0.05æˆ–0.01ï¼‰</div>
                    </div>
                </div>

                <div class="section">
                    <h3>ğŸ¨ å›¾è¡¨è®¾ç½®</h3>
                    <div class="input-group">
                        <label>å›¾è¡¨æ ‡é¢˜ï¼š</label>
                        <input type="text" id="plotTitle" value="Volcano Plot - Differential Gene Expression">
                    </div>
                    <div class="input-group">
                        <label>ç”»å¸ƒå®½åº¦ï¼ˆåƒç´ ï¼‰ï¼š</label>
                        <input type="number" id="plotWidth" value="800" min="400" max="1600">
                    </div>
                    <div class="input-group">
                        <label>ç”»å¸ƒé«˜åº¦ï¼ˆåƒç´ ï¼‰ï¼š</label>
                        <input type="number" id="plotHeight" value="600" min="300" max="1200">
                    </div>
                    <div class="input-group">
                        <label>ç‚¹çš„å¤§å°ï¼š</label>
                        <input type="range" id="pointSize" min="2" max="10" value="4" step="0.5">
                        <span id="pointSizeValue">4</span>
                    </div>
                    <div class="input-group">
                        <label>ç‚¹çš„é€æ˜åº¦ï¼š</label>
                        <input type="range" id="pointAlpha" min="0.1" max="1" value="0.6" step="0.1">
                        <span id="pointAlphaValue">0.6</span>
                    </div>
                    <div class="input-group">
                        <label>ä¸Šè°ƒåŸºå› é¢œè‰²ï¼š</label>
                        <div class="color-picker">
                            <input type="color" id="upColor" value="#e74c3c">
                            <span>çº¢è‰²ï¼ˆä¸Šè°ƒï¼‰</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ä¸‹è°ƒåŸºå› é¢œè‰²ï¼š</label>
                        <div class="color-picker">
                            <input type="color" id="downColor" value="#3498db">
                            <span>è“è‰²ï¼ˆä¸‹è°ƒï¼‰</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>éæ˜¾è‘—åŸºå› é¢œè‰²ï¼š</label>
                        <div class="color-picker">
                            <input type="color" id="nsColor" value="#95a5a6">
                            <span>ç°è‰²ï¼ˆæ— æ˜¾è‘—å·®å¼‚ï¼‰</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>æ˜¾ç¤ºåŸºå› åæ•°é‡ï¼š</label>
                        <input type="number" id="labelCount" value="10" min="0" max="50">
                        <div class="help-text">æ ‡æ³¨æœ€æ˜¾è‘—çš„åŸºå› åï¼ˆ0è¡¨ç¤ºä¸æ ‡æ³¨ï¼‰</div>
                    </div>
                </div>

                <div class="section">
                    <h3>ğŸ’¾ å¯¼å‡ºé€‰é¡¹</h3>
                    <div class="btn-group">
                        <button onclick="generatePlot()">ğŸ”„ ç”Ÿæˆå›¾è¡¨</button>
                        <button onclick="exportPNG()" class="secondary">ğŸ“· å¯¼å‡ºPNG</button>
                        <button onclick="exportSVG()">ğŸ“„ å¯¼å‡ºSVG</button>
                        <button onclick="exportCSV()">ğŸ“‘ å¯¼å‡ºæ•°æ®CSV</button>
                    </div>
                    <button onclick="generateRandomData()" style="width: 100%; margin-top: 10px; background: #9b59b6;">
                        ğŸ² ç”Ÿæˆéšæœºæ•°æ®
                    </button>
                </div>
            </div>

            <div class="preview-area">
                <div id="volcanoPlot">
                    <div class="plot-title">è¯·è¾“å…¥æ•°æ®å¹¶ç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let currentTab = 'excel';

        // ç”Ÿæˆéšæœºæ•°æ®
        function generateRandomData() {
            const geneCount = 500; // ç”Ÿæˆ500ä¸ªåŸºå› 
            const tbody = document.getElementById('excelTableBody');

            // æ¸…ç©ºç°æœ‰æ•°æ®
            tbody.innerHTML = '';

            // æ·»åŠ è¶³å¤Ÿçš„è¡Œ
            for (let i = 0; i < geneCount; i++) {
                addRow();
            }

            // ç”Ÿæˆéšæœºæ•°æ®
            for (let i = 0; i < geneCount; i++) {
                const row = tbody.rows[i];
                const inputs = row.querySelectorAll('input');

                // åŸºå› å
                inputs[0].value = `Gene${i + 1}`;

                // Log2FC: æ­£æ€åˆ†å¸ƒï¼ŒèŒƒå›´ -5 åˆ° 5
                // å¤§éƒ¨åˆ†åœ¨ -2 åˆ° 2 ä¹‹é—´ï¼Œå°‘æ•°æœ‰æç«¯å€¼
                let log2fc;
                const rand = Math.random();
                if (rand < 0.15) {
                    // 15% å¼ºçƒˆä¸Šè°ƒ
                    log2fc = (Math.random() * 3 + 1.5).toFixed(3);
                } else if (rand < 0.30) {
                    // 15% å¼ºçƒˆä¸‹è°ƒ
                    log2fc = (-Math.random() * 3 - 1.5).toFixed(3);
                } else if (rand < 0.50) {
                    // 20% ä¸­ç­‰ä¸Šè°ƒ
                    log2fc = (Math.random() * 1.5 + 0.5).toFixed(3);
                } else if (rand < 0.70) {
                    // 20% ä¸­ç­‰ä¸‹è°ƒ
                    log2fc = (-Math.random() * 1.5 - 0.5).toFixed(3);
                } else {
                    // 30% æ— æ˜¾è‘—å˜åŒ–
                    log2fc = ((Math.random() - 0.5) * 1).toFixed(3);
                }
                inputs[1].value = log2fc;

                // På€¼: å¯¹æ•°å‡åŒ€åˆ†å¸ƒ
                // æ˜¾è‘—å·®å¼‚çš„åŸºå› ç»™äºˆå°på€¼
                let pvalue;
                const absLog2fc = Math.abs(parseFloat(log2fc));
                if (absLog2fc > 1.5) {
                    // å¼ºçƒˆå·®å¼‚ï¼šå°på€¼
                    pvalue = (Math.random() * 0.01).toExponential(3);
                } else if (absLog2fc > 0.8) {
                    // ä¸­ç­‰å·®å¼‚ï¼šä¸­ç­‰på€¼
                    pvalue = (Math.random() * 0.05).toFixed(4);
                } else {
                    // æ— æ˜¾è‘—å·®å¼‚ï¼šå¤§på€¼
                    pvalue = (Math.random() * 0.5 + 0.1).toFixed(4);
                }
                inputs[2].value = pvalue;
            }

            alert(`æˆåŠŸç”Ÿæˆ ${geneCount} ä¸ªéšæœºåŸºå› æ•°æ®ï¼\nåŒ…æ‹¬ï¼šä¸Šè°ƒåŸºå› ã€ä¸‹è°ƒåŸºå› å’Œæ— æ˜¾è‘—å·®å¼‚åŸºå› ã€‚\nç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"æŸ¥çœ‹ç«å±±å›¾ã€‚`);
        }

        // æ›´æ–°æ»‘å—æ˜¾ç¤ºå€¼
        document.getElementById('pointSize').addEventListener('input', (e) => {
            document.getElementById('pointSizeValue').textContent = e.target.value;
        });
        document.getElementById('pointAlpha').addEventListener('input', (e) => {
            document.getElementById('pointAlphaValue').textContent = e.target.value;
        });

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'excel') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('excelTab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('textTab').classList.add('active');
            }
        }

        // åˆå§‹åŒ–è¡¨æ ¼
        function initTable() {
            const tbody = document.getElementById('excelTableBody');
            tbody.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                addRow();
            }
        }

        // æ·»åŠ è¡Œ
        function addRow() {
            const tbody = document.getElementById('excelTableBody');
            const row = tbody.insertRow();
            for (let i = 0; i < 3; i++) {
                const cell = row.insertCell();
                const input = document.createElement('input');
                input.type = 'text';
                cell.appendChild(input);
            }
        }

        // æ¸…ç©ºè¡¨æ ¼
        function clearTable() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè¡¨æ ¼å—ï¼Ÿ')) {
                initTable();
            }
        }

        // å¤„ç†ç²˜è´´äº‹ä»¶
        document.addEventListener('DOMContentLoaded', () => {
            const table = document.getElementById('excelTable');

            table.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text');
                const rows = pastedData.split('\n').filter(row => row.trim());

                let currentCell = e.target.closest('td');
                if (!currentCell) return;

                let currentRow = currentCell.parentElement;
                let startColIndex = Array.from(currentRow.cells).indexOf(currentCell);

                const tbody = document.getElementById('excelTableBody');
                let rowIndex = Array.from(tbody.rows).indexOf(currentRow);

                while (tbody.rows.length < rowIndex + rows.length) {
                    addRow();
                }

                rows.forEach((rowData, i) => {
                    const cells = rowData.split('\t');
                    const targetRow = tbody.rows[rowIndex + i];

                    cells.forEach((cellData, j) => {
                        const targetColIndex = startColIndex + j;
                        if (targetColIndex < 3) {
                            const input = targetRow.cells[targetColIndex].querySelector('input');
                            if (input) {
                                input.value = cellData.trim();
                            }
                        }
                    });
                });

                alert('æ•°æ®ç²˜è´´æˆåŠŸï¼å…± ' + rows.length + ' è¡Œ');
            });
        });

        // ä»è¡¨æ ¼è·å–æ•°æ®
        function getTableData() {
            const tbody = document.getElementById('excelTableBody');
            const data = [];

            for (let row of tbody.rows) {
                const inputs = row.querySelectorAll('input');
                const rowData = Array.from(inputs).map(input => input.value.trim());

                if (rowData[0] && rowData[1] && rowData[2]) {
                    data.push(rowData);
                }
            }

            return data;
        }

        // æ–‡ä»¶å¯¼å…¥
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                Papa.parse(file, {
                    complete: (results) => {
                        const csvText = results.data.map(row => row.join(',')).join('\n');
                        document.getElementById('dataInput').value = csvText;
                        alert('æ–‡ä»¶å¯¼å…¥æˆåŠŸï¼');
                    },
                    error: (error) => {
                        alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message);
                    }
                });
            }
        });

        function parseData() {
            if (currentTab === 'excel') {
                const tableData = getTableData();
                const data = [];

                tableData.forEach(row => {
                    const gene = row[0];
                    const log2fc = parseFloat(row[1]);
                    const pvalue = parseFloat(row[2]);

                    if (gene && !isNaN(log2fc) && !isNaN(pvalue) && pvalue > 0) {
                        data.push({
                            gene: gene,
                            log2fc: log2fc,
                            pvalue: pvalue,
                            negLogP: -Math.log10(pvalue)
                        });
                    }
                });

                return data;
            } else {
                const text = document.getElementById('dataInput').value.trim();
                if (!text) return [];

                const lines = text.split('\n').filter(line => line.trim());
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(s => s.trim());
                    if (parts.length >= 3) {
                        const gene = parts[0];
                        const log2fc = parseFloat(parts[1]);
                        const pvalue = parseFloat(parts[2]);

                        if (gene && !isNaN(log2fc) && !isNaN(pvalue) && pvalue > 0) {
                            data.push({
                                gene: gene,
                                log2fc: log2fc,
                                pvalue: pvalue,
                                negLogP: -Math.log10(pvalue)
                            });
                        }
                    }
                }
                return data;
            }
        }

        function generatePlot() {
            currentData = parseData();
            if (currentData.length === 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°æ®ï¼ç¡®ä¿åŒ…å«åŸºå› åã€Log2FCå’ŒPå€¼ã€‚');
                return;
            }

            const plotDiv = document.getElementById('volcanoPlot');
            const title = document.getElementById('plotTitle').value;
            const width = parseInt(document.getElementById('plotWidth').value);
            const height = parseInt(document.getElementById('plotHeight').value);
            const fcThreshold = parseFloat(document.getElementById('fcThreshold').value);
            const pThreshold = parseFloat(document.getElementById('pThreshold').value);
            const pointSize = parseFloat(document.getElementById('pointSize').value);
            const pointAlpha = parseFloat(document.getElementById('pointAlpha').value);
            const upColor = document.getElementById('upColor').value;
            const downColor = document.getElementById('downColor').value;
            const nsColor = document.getElementById('nsColor').value;
            const labelCount = parseInt(document.getElementById('labelCount').value);

            const negLogPThreshold = -Math.log10(pThreshold);

            // åˆ†ç±»åŸºå› 
            let upGenes = 0, downGenes = 0, nsGenes = 0;
            currentData.forEach(d => {
                if (d.log2fc > fcThreshold && d.negLogP > negLogPThreshold) {
                    d.category = 'up';
                    upGenes++;
                } else if (d.log2fc < -fcThreshold && d.negLogP > negLogPThreshold) {
                    d.category = 'down';
                    downGenes++;
                } else {
                    d.category = 'ns';
                    nsGenes++;
                }
            });

            // è·å–æœ€æ˜¾è‘—çš„åŸºå› ç”¨äºæ ‡æ³¨
            const sortedForLabel = [...currentData]
                .filter(d => d.category !== 'ns')
                .sort((a, b) => b.negLogP - a.negLogP)
                .slice(0, labelCount);

            // è®¡ç®—åæ ‡èŒƒå›´
            const maxLogFC = Math.max(...currentData.map(d => Math.abs(d.log2fc)));
            const maxNegLogP = Math.max(...currentData.map(d => d.negLogP));
            const xRange = Math.ceil(maxLogFC) + 1;
            const yRange = Math.ceil(maxNegLogP) + 1;

            // ç”»å¸ƒè¾¹è·
            const margin = { top: 40, right: 40, bottom: 60, left: 60 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            // åˆ›å»ºç”»å¸ƒ
            let html = `<div class="plot-title">${title}</div>`;
            html += `<canvas id="plotCanvas" width="${width}" height="${height}"></canvas>`;

            // æ·»åŠ å›¾ä¾‹
            html += '<div class="legend">';
            html += `<div class="legend-item"><div class="legend-color" style="background:${upColor}"></div><span>ä¸Šè°ƒ (${upGenes})</span></div>`;
            html += `<div class="legend-item"><div class="legend-color" style="background:${downColor}"></div><span>ä¸‹è°ƒ (${downGenes})</span></div>`;
            html += `<div class="legend-item"><div class="legend-color" style="background:${nsColor}"></div><span>æ— æ˜¾è‘—å·®å¼‚ (${nsGenes})</span></div>`;
            html += '</div>';

            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            html += '<div class="stats">';
            html += `<div class="stat-item"><div class="stat-value">${currentData.length}</div><div class="stat-label">æ€»åŸºå› æ•°</div></div>`;
            html += `<div class="stat-item"><div class="stat-value">${upGenes}</div><div class="stat-label">ä¸Šè°ƒåŸºå› </div></div>`;
            html += `<div class="stat-item"><div class="stat-value">${downGenes}</div><div class="stat-label">ä¸‹è°ƒåŸºå› </div></div>`;
            html += '</div>';

            plotDiv.innerHTML = html;

            // ç»˜åˆ¶ç«å±±å›¾
            const canvas = document.getElementById('plotCanvas');
            const ctx = canvas.getContext('2d');

            // èƒŒæ™¯
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);

            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 10; i++) {
                const x = margin.left + (plotWidth / 10) * i;
                const y = margin.top + (plotHeight / 10) * i;
                ctx.beginPath();
                ctx.moveTo(x, margin.top);
                ctx.lineTo(x, height - margin.bottom);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(width - margin.right, y);
                ctx.stroke();
            }

            // ç»˜åˆ¶é˜ˆå€¼çº¿
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 1.5;
            ctx.setLineDash([5, 5]);

            // å‚ç›´é˜ˆå€¼çº¿
            const xPosThreshold = margin.left + ((fcThreshold + xRange) / (2 * xRange)) * plotWidth;
            const xNegThreshold = margin.left + ((-fcThreshold + xRange) / (2 * xRange)) * plotWidth;
            ctx.beginPath();
            ctx.moveTo(xPosThreshold, margin.top);
            ctx.lineTo(xPosThreshold, height - margin.bottom);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(xNegThreshold, margin.top);
            ctx.lineTo(xNegThreshold, height - margin.bottom);
            ctx.stroke();

            // æ°´å¹³é˜ˆå€¼çº¿
            const yThreshold = height - margin.bottom - (negLogPThreshold / yRange) * plotHeight;
            ctx.beginPath();
            ctx.moveTo(margin.left, yThreshold);
            ctx.lineTo(width - margin.right, yThreshold);
            ctx.stroke();
            ctx.setLineDash([]);

            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, height - margin.bottom);
            ctx.lineTo(width - margin.right, height - margin.bottom);
            ctx.stroke();

            // åæ ‡è½´æ ‡ç­¾
            ctx.fillStyle = '#000';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Log2 Fold Change', width / 2, height - 10);

            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('-Log10 (P-value)', 0, 0);
            ctx.restore();

            // Xè½´åˆ»åº¦
            ctx.font = '12px Arial';
            for (let i = -xRange; i <= xRange; i += Math.ceil(xRange / 5)) {
                const x = margin.left + ((i + xRange) / (2 * xRange)) * plotWidth;
                ctx.fillText(i.toString(), x, height - margin.bottom + 20);
                ctx.beginPath();
                ctx.moveTo(x, height - margin.bottom);
                ctx.lineTo(x, height - margin.bottom + 5);
                ctx.stroke();
            }

            // Yè½´åˆ»åº¦
            ctx.textAlign = 'right';
            for (let i = 0; i <= Math.ceil(yRange); i += Math.ceil(yRange / 5)) {
                const y = height - margin.bottom - (i / yRange) * plotHeight;
                ctx.fillText(i.toString(), margin.left - 10, y + 5);
                ctx.beginPath();
                ctx.moveTo(margin.left - 5, y);
                ctx.lineTo(margin.left, y);
                ctx.stroke();
            }

            // ç»˜åˆ¶æ•°æ®ç‚¹
            currentData.forEach(d => {
                const x = margin.left + ((d.log2fc + xRange) / (2 * xRange)) * plotWidth;
                const y = height - margin.bottom - (d.negLogP / yRange) * plotHeight;

                let color;
                if (d.category === 'up') color = upColor;
                else if (d.category === 'down') color = downColor;
                else color = nsColor;

                ctx.globalAlpha = pointAlpha;
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(x, y, pointSize, 0, 2 * Math.PI);
                ctx.fill();
            });

            ctx.globalAlpha = 1;

            // æ ‡æ³¨åŸºå› å
            if (labelCount > 0) {
                ctx.fillStyle = '#000';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'left';

                sortedForLabel.forEach(d => {
                    const x = margin.left + ((d.log2fc + xRange) / (2 * xRange)) * plotWidth;
                    const y = height - margin.bottom - (d.negLogP / yRange) * plotHeight;

                    ctx.fillText(d.gene, x + pointSize + 3, y + 4);
                });
            }
        }

        function exportPNG() {
            const plot = document.getElementById('volcanoPlot');
            html2canvas(plot, {
                backgroundColor: '#ffffff',
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'volcano_plot.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function exportSVG() {
            const plot = document.getElementById('volcanoPlot');
            html2canvas(plot, {
                backgroundColor: '#ffffff',
                scale: 2
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const width = canvas.width;
                const height = canvas.height;

                // åˆ›å»ºSVG
                const svg = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
     width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
    <image width="${width}" height="${height}" xlink:href="${imgData}"/>
</svg>`;

                // ä¸‹è½½SVG
                const blob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'volcano_plot.svg';
                link.click();
                URL.revokeObjectURL(link.href);
            });
        }

        function exportCSV() {
            if (currentData.length === 0) {
                alert('è¯·å…ˆç”Ÿæˆå›¾è¡¨ï¼');
                return;
            }

            let csv = 'Gene,Log2FC,Pvalue,NegLogP,Category\n';
            currentData.forEach(row => {
                csv += `${row.gene},${row.log2fc},${row.pvalue},${row.negLogP.toFixed(3)},${row.category}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'volcano_plot_data.csv';
            link.click();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initTable();

            // åŠ è½½ç¤ºä¾‹æ•°æ®åˆ°è¡¨æ ¼
            const exampleRows = [
                ['BRCA1', '3.2', '0.0001'],
                ['TP53', '2.8', '0.0005'],
                ['MYC', '2.5', '0.001'],
                ['EGFR', '2.1', '0.005'],
                ['KRAS', '1.8', '0.01'],
                ['PIK3CA', '-2.5', '0.0008'],
                ['PTEN', '-2.2', '0.002'],
                ['AKT1', '-1.9', '0.008'],
                ['VEGFA', '0.8', '0.2'],
                ['CDK4', '0.5', '0.4']
            ];

            const tbody = document.getElementById('excelTableBody');
            exampleRows.forEach((rowData, i) => {
                const row = tbody.rows[i];
                if (row) {
                    rowData.forEach((value, j) => {
                        const input = row.cells[j].querySelector('input');
                        if (input) input.value = value;
                    });
                }
            });

            // æ–‡æœ¬æ¨¡å¼çš„ç¤ºä¾‹æ•°æ®
            const exampleData = `Gene,Log2FC,Pvalue
BRCA1,3.2,0.0001
TP53,2.8,0.0005
MYC,2.5,0.001
EGFR,2.1,0.005
KRAS,1.8,0.01
PIK3CA,-2.5,0.0008
PTEN,-2.2,0.002
AKT1,-1.9,0.008
VEGFA,0.8,0.2
CDK4,0.5,0.4`;
            document.getElementById('dataInput').value = exampleData;
        });
    </script>
</body>
</html>
